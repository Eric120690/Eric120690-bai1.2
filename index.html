<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ú¶ LEXON ‚Äî H·ªçc T·ª´ V·ª±ng</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- ‚ú¶ Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, deleteDoc, updateDoc }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDIrVL0Dqxs8vXMPAJDiEVoL-ELkahz3aA",
    authDomain: "lexon-c4f76.firebaseapp.com",
    projectId: "lexon-c4f76",
    storageBucket: "lexon-c4f76.firebasestorage.app",
    messagingSenderId: "559467320984",
    appId: "1:559467320984:web:dcc9570790b1d54fba22ed"
  };

  const app      = initializeApp(firebaseConfig);
  const db       = getFirestore(app);
  const auth     = getAuth(app);
  const provider = new GoogleAuthProvider();

  // G√°n ra window
  window._db         = db;
  window._auth       = auth;
  window._doc        = doc;
  window._setDoc     = setDoc;
  window._getDoc     = getDoc;
  window._collection = collection;
  window._getDocs    = getDocs;
  window._addDoc     = addDoc;
  window._deleteDoc  = deleteDoc;
  window._updateDoc  = updateDoc;

  // ƒêƒÉng nh·∫≠p Google
  window._signIn = () => signInWithPopup(auth, provider);
  window._signOut = () => signOut(auth);

  // Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
  onAuthStateChanged(auth, (user) => {
    window._currentUser = user;
    window.dispatchEvent(new CustomEvent('auth-changed', { detail: user }));
    if (!window._firebaseReady) {
      window._firebaseReady = true;
      window.dispatchEvent(new Event('firebase-ready'));
    }
  });
</script>
<style>
  :root {
    --neon-cyan: #00f5ff;
    --neon-pink: #ff006e;
    --neon-purple: #bf00ff;
    --neon-green: #39ff14;
    --neon-yellow: #ffe600;
    --dark: #05050f;
    --dark2: #0d0d1f;
    --glass: rgba(255,255,255,0.04);
    --glass-border: rgba(255,255,255,0.08);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--dark);
    color: #fff;
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }
  body::before {
    content:'';
    position:fixed; inset:0;
    background:
      radial-gradient(ellipse 80% 60% at 10% 20%, rgba(0,245,255,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 60% 80% at 90% 80%, rgba(191,0,255,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 50% 50% at 50% 50%, rgba(255,0,110,0.04) 0%, transparent 70%);
    pointer-events:none; z-index:0;
  }
  body::after {
    content:'';
    position:fixed; inset:0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px);
    pointer-events:none; z-index:1;
  }
  .container { max-width:920px; margin:0 auto; padding:30px 20px; position:relative; z-index:2; }

  /* HEADER */
  .header { text-align:center; margin-bottom:40px; }
  .logo {
    font-family:'Syne',sans-serif; font-size:3.2rem; font-weight:800; letter-spacing:0.12em;
    background:linear-gradient(90deg, var(--neon-cyan), var(--neon-purple), var(--neon-pink));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    filter:drop-shadow(0 0 30px rgba(0,245,255,0.4));
    animation:logoGlow 3s ease-in-out infinite alternate;
  }
  @keyframes logoGlow {
    from { filter:drop-shadow(0 0 20px rgba(0,245,255,0.3)); }
    to   { filter:drop-shadow(0 0 50px rgba(191,0,255,0.5)); }
  }
  .tagline { color:rgba(255,255,255,0.35); font-size:0.75rem; letter-spacing:0.4em; text-transform:uppercase; margin-top:6px; }

  /* TABS */
  .tabs { display:flex; gap:4px; background:var(--dark2); border:1px solid var(--glass-border); border-radius:14px; padding:5px; margin-bottom:32px; }
  .tab-btn {
    flex:1; padding:12px 16px; background:transparent; border:none; border-radius:10px;
    color:rgba(255,255,255,0.4); font-family:'Syne',sans-serif; font-size:0.8rem; font-weight:700;
    letter-spacing:0.05em; cursor:pointer; transition:all 0.25s; text-transform:uppercase;
  }
  .tab-btn.active {
    background:linear-gradient(135deg, rgba(0,245,255,0.15), rgba(191,0,255,0.15));
    color:var(--neon-cyan); border:1px solid rgba(0,245,255,0.3);
    text-shadow:0 0 10px rgba(0,245,255,0.5);
  }
  .tab-btn:hover:not(.active) { color:rgba(255,255,255,0.7); background:var(--glass); }

  .panel { display:none; animation:fadeUp 0.3s ease; }
  .panel.active { display:block; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

  .card { background:var(--glass); border:1px solid var(--glass-border); border-radius:20px; padding:28px; backdrop-filter:blur(10px); }

  .section-label {
    font-family:'Syne',sans-serif; font-size:0.7rem; letter-spacing:0.35em; text-transform:uppercase;
    color:var(--neon-cyan); margin-bottom:12px; display:flex; align-items:center; gap:8px;
  }
  .section-label::after { content:''; flex:1; height:1px; background:linear-gradient(90deg, rgba(0,245,255,0.3), transparent); }

  /* INPUT PANEL */
  .import-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px; }
  @media(max-width:620px) { .import-grid { grid-template-columns:1fr; } }

  .excel-dropzone {
    border:2px dashed rgba(57,255,20,0.3); border-radius:16px; padding:28px 20px;
    text-align:center; cursor:pointer; transition:all 0.25s; background:rgba(57,255,20,0.03);
    position:relative; overflow:hidden; min-height:200px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .excel-dropzone:hover, .excel-dropzone.drag-over {
    border-color:rgba(57,255,20,0.7); background:rgba(57,255,20,0.07);
    box-shadow:0 0 30px rgba(57,255,20,0.1);
  }
  .excel-dropzone input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .dz-icon { font-size:2.2rem; margin-bottom:10px; display:block; }
  .dz-title { font-family:'Syne',sans-serif; font-size:0.92rem; font-weight:700; color:var(--neon-green); margin-bottom:5px; }
  .dz-sub { font-size:0.68rem; color:rgba(255,255,255,0.3); line-height:1.6; }
  .col-tags { margin-top:12px; display:flex; flex-wrap:wrap; gap:4px; justify-content:center; }
  .col-tag {
    font-size:0.58rem; letter-spacing:0.1em; padding:3px 7px;
    background:rgba(57,255,20,0.08); border:1px solid rgba(57,255,20,0.2);
    border-radius:20px; color:rgba(57,255,20,0.7); text-transform:uppercase;
  }

  .text-import { display:flex; flex-direction:column; }
  textarea {
    width:100%; background:rgba(0,0,0,0.4); border:1px solid var(--glass-border); border-radius:12px;
    color:#fff; font-family:'Inter',sans-serif; font-size:0.88rem; line-height:1.8;
    padding:14px; resize:vertical; min-height:170px; outline:none; transition:border-color 0.2s; flex:1;
  }
  textarea:focus { border-color:rgba(0,245,255,0.4); }
  textarea::placeholder { color:rgba(255,255,255,0.18); }
  .fmt-hint { font-size:0.67rem; color:rgba(255,255,255,0.22); margin-top:8px; line-height:1.7; }
  .fmt-hint span { color:var(--neon-yellow); }

  .btn-primary {
    display:inline-flex; align-items:center; gap:8px; padding:13px 24px;
    background:linear-gradient(135deg, var(--neon-cyan), var(--neon-purple)); border:none; border-radius:12px;
    color:#000; font-family:'Syne',sans-serif; font-size:0.88rem; font-weight:800;
    letter-spacing:0.08em; cursor:pointer; transition:all 0.2s; text-transform:uppercase;
  }
  .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(0,245,255,0.35); }

  .btn-danger {
    display:inline-flex; align-items:center; gap:8px; padding:11px 18px;
    background:rgba(255,0,110,0.08); border:1px solid rgba(255,0,110,0.25); border-radius:12px;
    color:var(--neon-pink); font-family:'Syne',sans-serif; font-size:0.82rem; font-weight:700;
    letter-spacing:0.05em; cursor:pointer; transition:all 0.2s; text-transform:uppercase;
  }
  .btn-danger:hover { background:rgba(255,0,110,0.15); transform:translateY(-2px); box-shadow:0 6px 20px rgba(255,0,110,0.2); }

  .import-toast {
    padding:13px 18px; border-radius:12px; font-size:0.8rem;
    display:none; align-items:center; gap:10px; margin-top:14px; animation:fadeUp 0.3s ease;
  }
  .import-toast.success { display:flex; background:rgba(57,255,20,0.08); border:1px solid rgba(57,255,20,0.25); color:var(--neon-green); }
  .import-toast.error   { display:flex; background:rgba(255,0,110,0.08); border:1px solid rgba(255,0,110,0.25); color:var(--neon-pink); }

  .storage-row { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-top:16px; }
  .storage-badge {
    display:inline-flex; align-items:center; gap:6px; font-size:0.63rem;
    letter-spacing:0.2em; text-transform:uppercase; color:var(--neon-purple);
    background:rgba(191,0,255,0.08); border:1px solid rgba(191,0,255,0.2); border-radius:20px; padding:5px 12px;
  }
  .storage-dot { width:6px; height:6px; border-radius:50%; background:var(--neon-purple); box-shadow:0 0 6px var(--neon-purple); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* MODAL */
  .modal-overlay {
    display:none; position:fixed; inset:0; background:rgba(0,0,0,0.82);
    z-index:100; align-items:center; justify-content:center; backdrop-filter:blur(4px);
  }
  .modal-overlay.show { display:flex; }
  .modal {
    background:var(--dark2); border:1px solid var(--glass-border); border-radius:20px; padding:28px;
    max-width:580px; width:92%; max-height:82vh; display:flex; flex-direction:column; animation:fadeUp 0.3s ease;
  }
  .modal-title { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:800; color:var(--neon-green); margin-bottom:6px; }
  .modal-sub   { font-size:0.75rem; color:rgba(255,255,255,0.35); margin-bottom:16px; line-height:1.5; }
  .modal-list  { overflow-y:auto; flex:1; margin-bottom:16px; border:1px solid var(--glass-border); border-radius:10px; }
  .modal-list::-webkit-scrollbar { width:4px; }
  .modal-list::-webkit-scrollbar-thumb { background:rgba(57,255,20,0.2); border-radius:4px; }
  .modal-row { padding:9px 14px; border-bottom:1px solid rgba(255,255,255,0.04); display:flex; align-items:center; gap:10px; font-size:0.78rem; }
  .modal-row:last-child { border-bottom:none; }
  .mw { color:#fff; font-weight:700; min-width:110px; }
  .mm { color:rgba(255,255,255,0.5); flex:1; }
  .mn { color:var(--neon-purple); font-size:0.68rem; }
  .modal-actions { display:flex; gap:10px; }
  .btn-confirm {
    flex:1; padding:13px; background:linear-gradient(135deg, var(--neon-green), var(--neon-cyan));
    border:none; border-radius:12px; color:#000; font-family:'Syne',sans-serif;
    font-size:0.88rem; font-weight:800; cursor:pointer; text-transform:uppercase; letter-spacing:0.06em; transition:all 0.2s;
  }
  .btn-confirm:hover { box-shadow:0 6px 20px rgba(57,255,20,0.3); transform:translateY(-1px); }
  .btn-cancel {
    padding:13px 20px; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border);
    border-radius:12px; color:rgba(255,255,255,0.5); font-family:'Syne',sans-serif;
    font-size:0.88rem; font-weight:700; cursor:pointer; text-transform:uppercase; transition:all 0.2s;
  }
  .btn-cancel:hover { background:rgba(255,255,255,0.08); color:#fff; }

  /* LIST PANEL */
  .list-toolbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; gap:10px; }
  .word-count { font-size:0.75rem; color:rgba(255,255,255,0.4); letter-spacing:0.1em; }
  .word-count strong { color:var(--neon-cyan); font-size:1.05rem; }
  .filter-row { display:flex; gap:6px; margin-bottom:14px; }
  .filter-btn {
    padding:5px 12px; border-radius:20px; border:1px solid var(--glass-border);
    background:transparent; color:rgba(255,255,255,0.4); font-family:'Inter',sans-serif;
    font-size:0.68rem; cursor:pointer; transition:all 0.15s;
  }
  .filter-btn.active { background:rgba(0,245,255,0.1); border-color:rgba(0,245,255,0.3); color:var(--neon-cyan); }

  .word-table-wrap { max-height:450px; overflow-y:auto; border-radius:12px; border:1px solid var(--glass-border); }
  .word-table-wrap::-webkit-scrollbar { width:4px; }
  .word-table-wrap::-webkit-scrollbar-thumb { background:rgba(0,245,255,0.2); border-radius:4px; }
  .word-table { width:100%; border-collapse:collapse; font-size:0.78rem; }
  .word-table thead th {
    padding:10px 12px; text-align:left; font-family:'Syne',sans-serif; font-size:0.62rem;
    letter-spacing:0.2em; text-transform:uppercase; color:rgba(255,255,255,0.3);
    background:rgba(0,0,0,0.5); border-bottom:1px solid var(--glass-border); position:sticky; top:0; z-index:1;
  }
  .word-table tbody tr { border-bottom:1px solid rgba(255,255,255,0.04); transition:background 0.15s; }
  .word-table tbody tr:hover { background:rgba(255,255,255,0.03); }
  .word-table tbody tr.mastered-row { background:rgba(57,255,20,0.02); }
  .word-table tbody tr.mastered-row td:first-child { border-left:3px solid rgba(57,255,20,0.5); }
  .word-table td { padding:10px 12px; vertical-align:middle; }
  .td-word { font-family:'Syne',sans-serif; font-weight:700; color:#fff; }
  .td-phonetic { color:var(--neon-cyan); font-size:0.72rem; margin-top:2px; }
  .td-meaning { color:rgba(255,255,255,0.75); }
  .lv {
    display:inline-block; padding:2px 7px; border-radius:20px; font-size:0.6rem;
    letter-spacing:0.1em; font-weight:700; text-transform:uppercase;
  }
  .lv-a1,.lv-a2 { background:rgba(57,255,20,0.1); color:var(--neon-green); border:1px solid rgba(57,255,20,0.2); }
  .lv-b1,.lv-b2 { background:rgba(0,245,255,0.1); color:var(--neon-cyan);  border:1px solid rgba(0,245,255,0.2); }
  .lv-c1,.lv-c2 { background:rgba(255,0,110,0.1); color:var(--neon-pink);  border:1px solid rgba(255,0,110,0.2); }
  .chip-remove { background:none; border:none; color:rgba(255,0,110,0.4); cursor:pointer; font-size:0.95rem; transition:color 0.15s,transform 0.15s; padding:2px 4px; }
  .chip-remove:hover { color:var(--neon-pink); transform:scale(1.2); }

  /* ===== PH√ÅT √ÇM ===== */
  .speak-btn {
    display:inline-flex; align-items:center; justify-content:center; gap:5px;
    background:none; border:1px solid rgba(0,245,255,0.2); border-radius:8px;
    color:rgba(0,245,255,0.6); cursor:pointer; font-size:0.72rem; font-family:'Inter',sans-serif;
    padding:4px 9px; transition:all 0.18s; white-space:nowrap;
  }
  .speak-btn:hover { border-color:var(--neon-cyan); color:var(--neon-cyan); background:rgba(0,245,255,0.07); box-shadow:0 0 12px rgba(0,245,255,0.15); }
  .speak-btn.playing { border-color:var(--neon-cyan); color:var(--neon-cyan); background:rgba(0,245,255,0.1); animation:speakPulse 0.6s ease infinite alternate; }
  @keyframes speakPulse { from{box-shadow:0 0 6px rgba(0,245,255,0.3)} to{box-shadow:0 0 18px rgba(0,245,255,0.6)} }

  /* Big speak button on flashcard */
  .fc-speak-row { display:flex; gap:8px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
  .fc-speak-btn {
    display:inline-flex; align-items:center; gap:7px; padding:9px 18px;
    border-radius:30px; border:none; cursor:pointer; font-family:'Syne',sans-serif;
    font-size:0.78rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; transition:all 0.2s;
  }
  .fc-speak-us {
    background:linear-gradient(135deg,rgba(0,245,255,0.15),rgba(0,245,255,0.05));
    border:1px solid rgba(0,245,255,0.35); color:var(--neon-cyan);
  }
  .fc-speak-uk {
    background:linear-gradient(135deg,rgba(191,0,255,0.15),rgba(191,0,255,0.05));
    border:1px solid rgba(191,0,255,0.35); color:var(--neon-purple);
  }
  .fc-speak-us:hover { background:rgba(0,245,255,0.18); box-shadow:0 4px 20px rgba(0,245,255,0.2); transform:translateY(-2px); }
  .fc-speak-uk:hover { background:rgba(191,0,255,0.18); box-shadow:0 4px 20px rgba(191,0,255,0.2); transform:translateY(-2px); }
  .fc-speak-us.playing, .fc-speak-uk.playing { animation:speakPulse 0.6s ease infinite alternate; }
  .fc-speak-uk.playing { animation-name:speakPulseP; }
  @keyframes speakPulseP { from{box-shadow:0 0 6px rgba(191,0,255,0.3)} to{box-shadow:0 0 20px rgba(191,0,255,0.6)} }

  .fc-cambridge-link {
    display:inline-flex; align-items:center; gap:5px; font-size:0.65rem; color:rgba(255,255,255,0.25);
    text-decoration:none; margin-top:6px; transition:color 0.15s; letter-spacing:0.1em;
  }
  .fc-cambridge-link:hover { color:rgba(255,255,255,0.55); }

  /* TTS engine badge */
  .tts-badge {
    display:inline-flex; align-items:center; gap:5px; font-size:0.6rem; letter-spacing:0.15em;
    text-transform:uppercase; color:rgba(0,245,255,0.4); margin-top:4px;
  }

  /* Auto-play toggle */
  .autoplay-toggle { display:flex; align-items:center; gap:8px; }
  .toggle-switch { position:relative; width:34px; height:18px; }
  .toggle-switch input { opacity:0; width:0; height:0; }
  .toggle-track {
    position:absolute; inset:0; border-radius:18px; cursor:pointer;
    background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15); transition:all 0.25s;
  }
  .toggle-track::before {
    content:''; position:absolute; width:12px; height:12px; left:2px; top:2px;
    border-radius:50%; background:rgba(255,255,255,0.4); transition:all 0.25s;
  }
  .toggle-switch input:checked + .toggle-track { background:rgba(0,245,255,0.25); border-color:rgba(0,245,255,0.5); }
  .toggle-switch input:checked + .toggle-track::before { transform:translateX(16px); background:var(--neon-cyan); box-shadow:0 0 6px rgba(0,245,255,0.6); }
  .toggle-label { font-size:0.65rem; color:rgba(255,255,255,0.35); letter-spacing:0.1em; text-transform:uppercase; }

  /* FLASHCARD */
  .stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:22px; }
  .stat-card { background:var(--glass); border:1px solid var(--glass-border); border-radius:14px; padding:14px; text-align:center; }
  .stat-value { font-family:'Syne',sans-serif; font-size:1.8rem; font-weight:800; }
  .stat-label { font-size:0.62rem; letter-spacing:0.25em; text-transform:uppercase; color:rgba(255,255,255,0.3); margin-top:4px; }
  .stat-card:nth-child(1) .stat-value { color:var(--neon-cyan); }
  .stat-card:nth-child(2) .stat-value { color:var(--neon-green); }
  .stat-card:nth-child(3) .stat-value { color:var(--neon-pink); }

  .fc-controls { display:flex; align-items:center; justify-content:space-between; margin-bottom:22px; flex-wrap:wrap; gap:10px; }
  .prog-info { font-size:0.75rem; color:rgba(255,255,255,0.4); }
  .prog-info strong { color:var(--neon-purple); font-size:1rem; }
  .prog-wrap { flex:1; min-width:80px; height:4px; background:rgba(255,255,255,0.08); border-radius:4px; overflow:hidden; }
  .prog-bar  { height:100%; background:linear-gradient(90deg, var(--neon-cyan), var(--neon-purple)); border-radius:4px; transition:width 0.4s; box-shadow:0 0 8px rgba(0,245,255,0.5); }
  .shuffle-badge {
    display:inline-flex; align-items:center; gap:5px; font-size:0.63rem; letter-spacing:0.2em;
    text-transform:uppercase; color:var(--neon-purple); background:rgba(191,0,255,0.08);
    border:1px solid rgba(191,0,255,0.2); border-radius:20px; padding:5px 12px;
  }

  .fc-scene { perspective:1000px; margin-bottom:22px; }
  .flashcard {
    width:100%; min-height:240px; position:relative; transform-style:preserve-3d;
    transition:transform 0.6s cubic-bezier(0.4,0,0.2,1); cursor:pointer;
  }
  .flashcard.flipped { transform:rotateY(180deg); }
  .fc-face {
    position:absolute; inset:0; border-radius:20px; display:flex; flex-direction:column;
    align-items:center; justify-content:center; backface-visibility:hidden; padding:28px; text-align:center; min-height:240px;
  }
  .fc-front {
    background:linear-gradient(135deg, rgba(0,245,255,0.08), rgba(191,0,255,0.08));
    border:1px solid rgba(0,245,255,0.25); box-shadow:0 0 40px rgba(0,245,255,0.08);
  }
  .fc-back {
    background:linear-gradient(135deg, rgba(255,0,110,0.08), rgba(191,0,255,0.1));
    border:1px solid rgba(255,0,110,0.25); box-shadow:0 0 40px rgba(255,0,110,0.08);
    transform:rotateY(180deg);
  }
  .fc-hint { font-size:0.65rem; letter-spacing:0.25em; text-transform:uppercase; margin-bottom:14px; opacity:0.33; font-family:'Inter',sans-serif; }
  .fc-word { font-family:'Plus Jakarta Sans',sans-serif; font-size:2.6rem; font-weight:800; letter-spacing:0.01em; line-height:1.15; margin-bottom:6px; }
  .fc-front .fc-word {
    background:linear-gradient(135deg,#fff, rgba(0,245,255,0.8));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    filter:drop-shadow(0 0 20px rgba(0,245,255,0.4));
  }
  .fc-back .fc-word {
    background:linear-gradient(135deg,#fff, rgba(255,0,110,0.8));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    filter:drop-shadow(0 0 20px rgba(255,0,110,0.4));
  }
  .fc-phonetic { font-size:0.9rem; color:var(--neon-cyan); margin-bottom:6px; opacity:0.85; font-family:'Inter',sans-serif; }
  .fc-type { font-size:0.75rem; color:rgba(255,255,255,0.4); margin-bottom:8px; font-style:italic; font-family:'Inter',sans-serif; }
  .fc-level { font-size:0.62rem; padding:3px 10px; border-radius:20px; background:rgba(191,0,255,0.15); border:1px solid rgba(191,0,255,0.3); color:var(--neon-purple); letter-spacing:0.12em; margin-bottom:8px; text-transform:uppercase; font-family:'Inter',sans-serif; }
  .fc-desc  { font-size:0.82rem; color:rgba(255,255,255,0.58); max-width:400px; margin-bottom:7px; line-height:1.6; font-family:'Inter',sans-serif; }
  .fc-example { font-size:0.82rem; color:rgba(255,255,255,0.38); font-style:italic; max-width:420px; line-height:1.6; font-family:'Inter',sans-serif; }


  .feedback-correct { color:var(--neon-green); text-shadow:0 0 8px rgba(57,255,20,0.5); }
  .feedback-wrong   { color:var(--neon-pink); }

  .action-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
  .btn { flex:1; min-width:110px; padding:16px 18px; border:none; border-radius:14px; font-family:'Syne',sans-serif; font-size:0.88rem; font-weight:800; letter-spacing:0.06em; cursor:pointer; text-transform:uppercase; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:6px; }
  .btn-skip     { background:rgba(255,230,0,0.1);  border:1px solid rgba(255,230,0,0.35);  color:var(--neon-yellow); box-shadow:0 2px 12px rgba(255,230,0,0.08); }
  .btn-mastered { background:rgba(57,255,20,0.1);   border:1px solid rgba(57,255,20,0.35);   color:var(--neon-green);  box-shadow:0 2px 12px rgba(57,255,20,0.08); }
  .btn-flip     { background:rgba(0,245,255,0.1);   border:1px solid rgba(0,245,255,0.35);   color:var(--neon-cyan);   box-shadow:0 2px 12px rgba(0,245,255,0.08); }
  .btn-skip:hover     { background:rgba(255,230,0,0.18); box-shadow:0 6px 24px rgba(255,230,0,0.22); transform:translateY(-3px); }
  .btn-mastered:hover { background:rgba(57,255,20,0.18);  box-shadow:0 6px 24px rgba(57,255,20,0.22);  transform:translateY(-3px); }
  .btn-flip:hover     { background:rgba(0,245,255,0.18);  box-shadow:0 6px 24px rgba(0,245,255,0.22);  transform:translateY(-3px); }

  .empty-state { text-align:center; padding:50px 20px; color:rgba(255,255,255,0.2); }
  .empty-icon  { font-size:3rem; margin-bottom:14px; display:block; }
  .empty-state p { font-size:0.85rem; line-height:1.7; }

  .celebration { text-align:center; padding:50px 20px; }
  .celebration-icon { font-size:4rem; display:block; margin-bottom:18px; animation:bounce 0.8s ease infinite alternate; }
  @keyframes bounce { from{transform:translateY(0)} to{transform:translateY(-12px)} }
  .celebration h2 { font-family:'Syne',sans-serif; font-size:1.8rem; font-weight:800; background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:12px; }
  .celebration p { color:rgba(255,255,255,0.4); font-size:0.85rem; }
  .btn-restart { margin-top:24px; display:inline-flex; align-items:center; gap:8px; padding:14px 32px; background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan)); border:none; border-radius:12px; color:#000; font-family:'Syne',sans-serif; font-size:0.9rem; font-weight:800; letter-spacing:0.08em; cursor:pointer; transition:all 0.2s; text-transform:uppercase; }
  .btn-restart:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(57,255,20,0.35); }

  .warn-box { background:rgba(255,230,0,0.06); border:1px solid rgba(255,230,0,0.2); border-radius:12px; padding:16px 20px; font-size:0.82rem; color:var(--neon-yellow); display:flex; align-items:center; gap:10px; }

  /* Arrow navigation */
  .arrow-nav { display:flex; align-items:center; gap:8px; margin-bottom:10px; justify-content:center; }
  .btn-arrow {
    display:inline-flex; align-items:center; justify-content:center;
    width:42px; height:42px; border-radius:50%;
    background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12);
    color:rgba(255,255,255,0.5); font-size:1.1rem; cursor:pointer; transition:all 0.18s;
    user-select:none;
  }
  .btn-arrow:hover { background:rgba(0,245,255,0.12); border-color:rgba(0,245,255,0.4); color:var(--neon-cyan); transform:scale(1.08); }
  .btn-arrow:disabled { opacity:0.2; cursor:default; transform:none; }
  .arrow-nav-hint { font-size:0.6rem; color:rgba(255,255,255,0.22); letter-spacing:0.15em; text-transform:uppercase; font-family:'Inter',sans-serif; }

  /* AUTH BAR */
  .auth-bar {
    display:flex; align-items:center; justify-content:flex-end; gap:10px;
    margin-bottom:16px;
  }
  .auth-user {
    display:flex; align-items:center; gap:8px;
    background:var(--glass); border:1px solid var(--glass-border);
    border-radius:30px; padding:6px 14px 6px 8px;
  }
  .auth-avatar {
    width:28px; height:28px; border-radius:50%;
    border:1px solid rgba(0,245,255,0.3);
  }
  .auth-name { font-size:0.75rem; color:rgba(255,255,255,0.7); max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .btn-google {
    display:inline-flex; align-items:center; gap:8px; padding:9px 18px;
    background:#fff; border:none; border-radius:30px;
    color:#333; font-family:'Syne',sans-serif; font-size:0.8rem; font-weight:700;
    cursor:pointer; transition:all 0.2s; letter-spacing:0.04em;
  }
  .btn-google:hover { box-shadow:0 4px 20px rgba(255,255,255,0.2); transform:translateY(-1px); }
  .btn-google img { width:18px; height:18px; }
  .btn-signout {
    padding:7px 14px; background:rgba(255,0,110,0.08); border:1px solid rgba(255,0,110,0.2);
    border-radius:20px; color:rgba(255,0,110,0.7); font-size:0.7rem; font-family:'Syne',sans-serif;
    font-weight:700; cursor:pointer; transition:all 0.2s; letter-spacing:0.05em;
  }
  .btn-signout:hover { background:rgba(255,0,110,0.15); color:var(--neon-pink); }

  /* LOGIN OVERLAY */
  .login-overlay {
    display:flex; position:fixed; inset:0; z-index:200;
    background:rgba(5,5,15,0.95); backdrop-filter:blur(10px);
    align-items:center; justify-content:center; flex-direction:column; gap:24px;
  }
  .login-overlay.hidden { display:none; }
  .login-box {
    background:var(--dark2); border:1px solid var(--glass-border);
    border-radius:24px; padding:48px 40px; text-align:center; max-width:380px; width:90%;
  }
  .login-logo { font-family:'Syne',sans-serif; font-size:2.5rem; font-weight:800; letter-spacing:0.12em;
    background:linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    margin-bottom:8px;
  }
  .login-sub { font-size:0.75rem; color:rgba(255,255,255,0.3); letter-spacing:0.2em; text-transform:uppercase; margin-bottom:32px; }
  .login-desc { font-size:0.85rem; color:rgba(255,255,255,0.5); margin-bottom:28px; line-height:1.7; }


  /* ===== PACK MANAGEMENT ===== */
  .screen { display:none; }
  .screen.active { display:block; }

  /* Pack selection screen */
  .packs-screen { padding:0; }
  .packs-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:12px; }
  .packs-title { font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; letter-spacing:0.1em; color:rgba(255,255,255,0.6); text-transform:uppercase; }
  .packs-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px; margin-bottom:20px; }

  .pack-card {
    background:var(--glass); border:1px solid var(--glass-border);
    border-radius:18px; padding:20px; cursor:pointer;
    transition:all 0.25s; position:relative; overflow:hidden;
  }
  .pack-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
    opacity:0; transition:opacity 0.25s;
  }
  .pack-card:hover { border-color:rgba(0,245,255,0.25); transform:translateY(-3px); background:rgba(255,255,255,0.06); }
  .pack-card:hover::before { opacity:1; }

  .pack-icon { font-size:1.8rem; margin-bottom:10px; }
  .pack-name { font-family:'Syne',sans-serif; font-size:0.95rem; font-weight:700; color:#fff; margin-bottom:6px; letter-spacing:0.04em; }
  .pack-meta { font-size:0.72rem; color:rgba(255,255,255,0.35); margin-bottom:12px; line-height:1.6; }

  .pack-progress-bar { height:3px; background:rgba(255,255,255,0.08); border-radius:3px; overflow:hidden; margin-bottom:6px; }
  .pack-progress-fill { height:100%; background:linear-gradient(90deg,var(--neon-cyan),var(--neon-green)); border-radius:3px; transition:width 0.4s ease; }
  .pack-progress-label { font-size:0.65rem; color:rgba(255,255,255,0.3); }

  .pack-actions { position:absolute; top:10px; right:10px; display:flex; gap:4px; opacity:0; transition:opacity 0.2s; }
  .pack-card:hover .pack-actions { opacity:1; }
  .pack-action-btn { width:24px; height:24px; border-radius:6px; border:none; background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.5); font-size:0.7rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
  .pack-action-btn:hover { background:rgba(255,0,110,0.2); color:var(--neon-pink); }
  .pack-action-btn.edit:hover { background:rgba(0,245,255,0.15); color:var(--neon-cyan); }

  .pack-add-card {
    background:transparent; border:1.5px dashed rgba(255,255,255,0.1);
    border-radius:18px; padding:20px; cursor:pointer;
    transition:all 0.25s; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; min-height:140px;
  }
  .pack-add-card:hover { border-color:rgba(0,245,255,0.3); background:rgba(0,245,255,0.03); }
  .pack-add-icon { font-size:1.8rem; color:rgba(255,255,255,0.2); }
  .pack-add-label { font-size:0.75rem; color:rgba(255,255,255,0.25); font-family:'Syne',sans-serif; letter-spacing:0.08em; }

  /* Pack study screen */
  .pack-study-header { display:flex; align-items:center; gap:12px; margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--glass-border); }
  .pack-back-btn { background:var(--glass); border:1px solid var(--glass-border); border-radius:10px; padding:8px 14px; color:rgba(255,255,255,0.5); font-size:0.78rem; font-family:'Syne',sans-serif; font-weight:700; cursor:pointer; letter-spacing:0.05em; transition:all 0.2s; }
  .pack-back-btn:hover { border-color:rgba(0,245,255,0.3); color:var(--neon-cyan); }
  .pack-study-title { font-family:'Syne',sans-serif; font-size:1rem; font-weight:800; color:#fff; letter-spacing:0.06em; }
  .pack-study-badge { font-size:0.65rem; color:rgba(255,255,255,0.3); background:var(--glass); border:1px solid var(--glass-border); padding:3px 8px; border-radius:6px; }

  /* New pack modal */
  .pack-modal-overlay { position:fixed; inset:0; z-index:300; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; padding:20px; }
  .pack-modal-overlay.show { display:flex; }
  .pack-modal { background:#0d0d1f; border:1px solid rgba(0,245,255,0.15); border-radius:20px; padding:32px; width:100%; max-width:400px; }
  .pack-modal-title { font-family:'Syne',sans-serif; font-size:1rem; font-weight:800; color:#fff; letter-spacing:0.08em; margin-bottom:20px; }
  .pack-modal input { width:100%; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:12px 14px; color:#fff; font-family:'Inter',sans-serif; font-size:0.9rem; outline:none; transition:border-color 0.2s; margin-bottom:14px; }
  .pack-modal input:focus { border-color:rgba(0,245,255,0.4); }
  .pack-modal-actions { display:flex; gap:10px; }

</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">LEXON</div>
    <div class="login-sub">Vocabulary Training System</div>
    <div class="login-desc">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u t·ª´ v·ª±ng c·ªßa b·∫°n<br>l√™n cloud v√† truy c·∫≠p m·ªçi n∆°i üåê</div>
    <button class="btn-google" onclick="window._signIn()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      ƒêƒÉng nh·∫≠p v·ªõi Google
    </button>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <div class="modal-title">‚äï X√°c nh·∫≠n Import t·ª´ Excel</div>
    <div class="modal-sub" id="modalSub"></div>
    <div class="modal-list" id="modalList"></div>
    <div class="modal-actions">
      <button class="btn-confirm" onclick="confirmImport()">‚úì Th√™m v√†o danh s√°ch</button>
      <button class="btn-cancel"  onclick="closeModal()">‚úï H·ªßy</button>
    </div>
  </div>
</div>

<!-- PACK MODAL -->
<div class="pack-modal-overlay" id="packModal">
  <div class="pack-modal">
    <div class="pack-modal-title" id="packModalTitle">‚ú¶ T·∫°o g√≥i t·ª´ v·ª±ng m·ªõi</div>
    <input type="text" id="packNameInput" placeholder="T√™n g√≥i, VD: IELTS Vocabulary, Business English..." maxlength="50">
    <input type="text" id="packDescInput" placeholder="M√¥ t·∫£ ng·∫Øn (t√πy ch·ªçn)" maxlength="80">
    <div class="pack-modal-actions">
      <button class="btn-primary" style="flex:1;justify-content:center" onclick="savePackModal()">‚úì L∆∞u</button>
      <button class="btn-danger" style="justify-content:center" onclick="closePackModal()">‚úï</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- AUTH BAR -->
  <div class="auth-bar" id="authBar"></div>

  <div class="header">
    <div class="logo">LEXON</div>
    <div class="tagline">Vocabulary Training System</div>
  </div>

  <!-- ========== PACKS SCREEN ========== -->
  <div class="screen active" id="screen-packs">
    <div class="card packs-screen">
      <div class="packs-header">
        <div class="packs-title">‚óà G√≥i t·ª´ v·ª±ng c·ªßa b·∫°n</div>
      </div>
      <div class="packs-grid" id="packsGrid">
        <!-- rendered by JS -->
      </div>
    </div>
  </div>

  <!-- ========== STUDY SCREEN ========== -->
  <div class="screen" id="screen-study">

    <div class="card" style="margin-bottom:12px;padding:16px 20px">
      <div class="pack-study-header">
        <button class="pack-back-btn" onclick="backToPacks()">‚Üê G√≥i t·ª´ v·ª±ng</button>
        <div>
          <div class="pack-study-title" id="studyPackName">T√™n g√≥i</div>
          <div class="pack-study-badge" id="studyPackBadge">0 t·ª´</div>
        </div>
      </div>
      <div class="tabs" style="margin-bottom:0">
        <button class="tab-btn active" onclick="switchTab('input')">‚ú¶ Nh·∫≠p T·ª´</button>
        <button class="tab-btn" onclick="switchTab('flashcard')">‚ö° Flashcard</button>
        <button class="tab-btn" onclick="switchTab('list')">‚óà Danh S√°ch</button>
      </div>
    </div>

  <!-- ========== NH·∫¨P T·ª™ ========== -->
  <div class="panel active" id="panel-input">
    <div class="card">
      <div class="section-label">Ngu·ªìn nh·∫≠p t·ª´ v·ª±ng</div>

      <div class="import-grid">

        <!-- Excel -->
        <div>
          <div class="section-label" style="font-size:0.62rem;margin-bottom:10px">üìó Import t·ª´ file Excel</div>
          <div class="excel-dropzone" id="dropzone"
            ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
            <span class="dz-icon">üìä</span>
            <div class="dz-title">K√©o & th·∫£ file v√†o ƒë√¢y</div>
            <div class="dz-sub">ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn file<br>.xlsx / .xls</div>
            <div class="col-tags">
              <span class="col-tag">No.</span>
              <span class="col-tag">Word</span>
              <span class="col-tag">Nghƒ©a TV</span>
              <span class="col-tag">Phonetics</span>
              <span class="col-tag">Description</span>
              <span class="col-tag">Example</span>
              <span class="col-tag">Type</span>
              <span class="col-tag">Level</span>
            </div>
          </div>
        </div>

        <!-- Manual -->
        <div class="text-import">
          <div class="section-label" style="font-size:0.62rem;margin-bottom:10px">‚å® Nh·∫≠p th·ªß c√¥ng</div>
          <textarea id="wordInput" placeholder="apple - qu·∫£ t√°o
beautiful - ƒë·∫πp ƒë·∫Ω - (adj)
serendipity - t√¨nh c·ªù may m·∫Øn - (n) - It was pure serendipity."></textarea>
          <div class="fmt-hint">M·ªói d√≤ng: <span>t·ª´</span> - <span>nghƒ©a</span> - <span>(lo·∫°i)</span> - <span>v√≠ d·ª•</span></div>
          <button class="btn-primary" style="margin-top:12px;width:100%;justify-content:center" onclick="importText()">‚äï Th√™m v√†o danh s√°ch</button>
        </div>
      </div>

      <div id="importToast" class="import-toast"></div>

      <div class="storage-row">
        <div class="storage-badge">
          <span class="storage-dot"></span>
          D·ªØ li·ªáu t·ª± ƒë·ªông l∆∞u tr√™n tr√¨nh duy·ªát (localStorage)
        </div>
        <div class="tts-badge">üîä TTS: Google Translate ¬∑ Cambridge Dictionary</div>
        <button class="btn-danger" onclick="clearAllData()">‚úï X√≥a to√†n b·ªô</button>
      </div>
    </div>
  </div>

  <!-- ========== FLASHCARD ========== -->
  <div class="panel" id="panel-flashcard">
    <div id="fc-content"></div>
  </div>

  <!-- ========== DANH S√ÅCH ========== -->
  <div class="panel" id="panel-list">
    <div class="card">
      <div class="list-toolbar">
        <div class="section-label" style="margin-bottom:0">Danh s√°ch t·ª´ v·ª±ng</div>
        <div class="word-count">
          <strong id="totalCount">0</strong> t·ª´ &nbsp;|&nbsp;
          <strong id="masteredCount" style="color:var(--neon-green)">0</strong> ƒë√£ thu·ªôc
        </div>
      </div>
      <div class="filter-row">
        <button class="filter-btn active" onclick="setFilter('all',this)">T·∫•t c·∫£</button>
        <button class="filter-btn" onclick="setFilter('learning',this)">ƒêang h·ªçc</button>
        <button class="filter-btn" onclick="setFilter('mastered',this)">ƒê√£ thu·ªôc</button>
      </div>
      <div class="word-table-wrap">
        <table class="word-table">
          <thead>
            <tr>
              <th style="width:30px">#</th>
              <th>T·ª´ / Phi√™n √¢m</th>
              <th>Nghƒ©a</th>
              <th style="width:55px">Level</th>
              <th style="width:36px">‚úì</th>
              <th style="width:34px"></th>
            </tr>
          </thead>
          <tbody id="wordTableBody"></tbody>
        </table>
      </div>
      <div id="listEmpty" class="empty-state" style="display:none">
        <span class="empty-icon">‚óà</span>
        <p>Ch∆∞a c√≥ t·ª´ n√†o.<br>H√£y import t·ª´ Excel ho·∫∑c nh·∫≠p th·ªß c√¥ng.</p>
      </div>
    </div>
  </div>

  </div><!-- end screen-study -->

</div><!-- end container -->

<script>
// ============================================================
//  STATE & PACK MANAGEMENT
// ============================================================
let words = [];
let packs = [];           // [{id, name, desc, createdAt}]
let currentPack = null;   // pack object ƒëang h·ªçc
let pendingImport = [];
let studyQueue = [];
let currentIndex = 0;
let isFlipped = false;
let correctStreak = 0;
let listFilter = 'all';
let editingPackId = null;

// --- Firebase helpers ---
function packsCol() {
  const uid = window._currentUser?.uid;
  return window._collection(window._db, 'users', uid, 'packs');
}
function wordsCol(packId) {
  const uid = window._currentUser?.uid;
  return window._collection(window._db, 'users', uid, 'packs', packId, 'words');
}

// --- Save/Load packs list ---
async function savePacks() {
  if (!window._firebaseReady || !window._currentUser) return;
  const uid = window._currentUser.uid;
  try {
    await window._setDoc(
      window._doc(window._db, 'users', uid),
      { packs: packs, updatedAt: Date.now() },
      { merge: true }
    );
  } catch(e) { console.warn('L·ªói l∆∞u packs:', e.message); }
}

async function loadPacks() {
  if (!window._firebaseReady || !window._currentUser) return [];
  const uid = window._currentUser.uid;
  try {
    const snap = await window._getDoc(window._doc(window._db, 'users', uid));
    if (snap.exists() && snap.data().packs) return snap.data().packs;
  } catch(e) { console.warn('L·ªói load packs:', e.message); }
  return [];
}

// --- Save/Load words in a pack ---
async function saveData() {
  if (!window._firebaseReady || !window._currentUser || !currentPack) return;
  const uid = window._currentUser.uid;
  try {
    await window._setDoc(
      window._doc(window._db, 'users', uid, 'packs', currentPack.id),
      { words: words, updatedAt: Date.now(), name: currentPack.name, desc: currentPack.desc || '' },
      { merge: true }
    );
  } catch(e) { console.warn('L·ªói l∆∞u words:', e.message); }
}

async function loadData() {
  if (!window._firebaseReady || !window._currentUser || !currentPack) return false;
  const uid = window._currentUser.uid;
  try {
    const snap = await window._getDoc(
      window._doc(window._db, 'users', uid, 'packs', currentPack.id)
    );
    if (snap.exists() && snap.data().words?.length) {
      words = snap.data().words;
      return true;
    }
  } catch(e) { console.warn('L·ªói load words:', e.message); }
  return false;
}

// ============================================================
//  PACK SCREEN
// ============================================================
async function showPacksScreen() {
  document.getElementById('screen-packs').classList.add('active');
  document.getElementById('screen-study').classList.remove('active');
  currentPack = null;
  words = [];
  // Load pack list with word counts
  packs = await loadPacks();
  await renderPacksGrid();
}

async function renderPacksGrid() {
  const grid = document.getElementById('packsGrid');
  grid.innerHTML = '';

  // Load word counts for each pack
  const uid = window._currentUser?.uid;
  const packDataMap = {};
  if (uid) {
    await Promise.all(packs.map(async p => {
      try {
        const snap = await window._getDoc(
          window._doc(window._db, 'users', uid, 'packs', p.id)
        );
        if (snap.exists()) packDataMap[p.id] = snap.data();
      } catch(e) {}
    }));
  }

  packs.forEach(pack => {
    const data = packDataMap[pack.id] || {};
    const wordArr = data.words || [];
    const total = wordArr.length;
    const mastered = wordArr.filter(w => w.mastered).length;
    const pct = total ? Math.round(mastered / total * 100) : 0;
    const icons = ['üìò','üìó','üìô','üìï','üìí','üìì'];
    const icon = icons[packs.indexOf(pack) % icons.length];

    const card = document.createElement('div');
    card.className = 'pack-card';
    card.innerHTML = \`
      <div class="pack-actions">
        <button class="pack-action-btn edit" onclick="editPack('\${pack.id}',event)" title="ƒê·ªïi t√™n">‚úé</button>
        <button class="pack-action-btn" onclick="deletePack('\${pack.id}',event)" title="X√≥a">‚úï</button>
      </div>
      <div class="pack-icon">\${icon}</div>
      <div class="pack-name">\${h(pack.name)}</div>
      <div class="pack-meta">\${pack.desc ? h(pack.desc)+'<br>' : ''}\${total} t·ª´ ¬∑ \${mastered} ƒë√£ thu·ªôc</div>
      <div class="pack-progress-bar"><div class="pack-progress-fill" style="width:\${pct}%"></div></div>
      <div class="pack-progress-label">\${pct}% ho√†n th√†nh</div>
    \`;
    card.addEventListener('click', () => openPack(pack));
    grid.appendChild(card);
  });

  // Add new pack card
  const addCard = document.createElement('div');
  addCard.className = 'pack-add-card';
  addCard.innerHTML = \`<div class="pack-add-icon">‚äï</div><div class="pack-add-label">T·∫†O G√ìI M·ªöI</div>\`;
  addCard.onclick = () => openPackModal();
  grid.appendChild(addCard);
}

async function openPack(pack) {
  currentPack = pack;
  document.getElementById('studyPackName').textContent = pack.name;
  document.getElementById('screen-packs').classList.remove('active');
  document.getElementById('screen-study').classList.add('active');
  switchTab('input');
  words = [];
  const loaded = await loadData();
  if (!loaded) words = [];
  buildQueue();
  renderList();
  updateStudyBadge();
}

function updateStudyBadge() {
  const mastered = words.filter(w => w.mastered).length;
  document.getElementById('studyPackBadge').textContent =
    words.length + ' t·ª´ ¬∑ ' + mastered + ' ƒë√£ thu·ªôc';
}

function backToPacks() {
  showPacksScreen();
}

// ============================================================
//  PACK MODAL (create / edit)
// ============================================================
function openPackModal(packId) {
  editingPackId = packId || null;
  const title = document.getElementById('packModalTitle');
  const nameInput = document.getElementById('packNameInput');
  const descInput = document.getElementById('packDescInput');
  if (packId) {
    const pack = packs.find(p => p.id === packId);
    title.textContent = '‚úé ƒê·ªïi t√™n g√≥i';
    nameInput.value = pack?.name || '';
    descInput.value = pack?.desc || '';
  } else {
    title.textContent = '‚ú¶ T·∫°o g√≥i t·ª´ v·ª±ng m·ªõi';
    nameInput.value = '';
    descInput.value = '';
  }
  document.getElementById('packModal').classList.add('show');
  setTimeout(() => nameInput.focus(), 100);
}

function closePackModal() {
  document.getElementById('packModal').classList.remove('show');
  editingPackId = null;
}

async function savePackModal() {
  const name = document.getElementById('packNameInput').value.trim();
  if (!name) { showToast('error', '‚ö† Vui l√≤ng nh·∫≠p t√™n g√≥i!'); return; }
  const desc = document.getElementById('packDescInput').value.trim();

  if (editingPackId) {
    const pack = packs.find(p => p.id === editingPackId);
    if (pack) { pack.name = name; pack.desc = desc; }
  } else {
    packs.push({ id: 'pack_' + Date.now(), name, desc, createdAt: Date.now() });
  }
  await savePacks();
  closePackModal();
  await renderPacksGrid();
  showToast('success', '‚úì ƒê√£ l∆∞u g√≥i t·ª´ v·ª±ng!');
}

function editPack(packId, event) {
  event.stopPropagation();
  openPackModal(packId);
}

async function deletePack(packId, event) {
  event.stopPropagation();
  const pack = packs.find(p => p.id === packId);
  if (!confirm(\`X√≥a g√≥i "\${pack?.name}"? T·∫•t c·∫£ t·ª´ v·ª±ng trong g√≥i s·∫Ω b·ªã m·∫•t.\`)) return;
  // Delete from Firebase
  const uid = window._currentUser?.uid;
  if (uid) {
    try {
      await window._deleteDoc(window._doc(window._db, 'users', uid, 'packs', packId));
    } catch(e) {}
  }
  packs = packs.filter(p => p.id !== packId);
  await savePacks();
  await renderPacksGrid();
  showToast('success', 'üóë ƒê√£ x√≥a g√≥i t·ª´ v·ª±ng');
}

// Close modal on overlay click
document.getElementById('packModal').addEventListener('click', function(e) {
  if (e.target === this) closePackModal();
});
// Enter key in modal
document.getElementById('packNameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') savePackModal();
});

// ============================================================
//  TABS
// ============================================================
function switchTab(tab) {
  ['input','flashcard','list'].forEach((t,i) => {
    document.querySelectorAll('.tab-btn')[i].classList.toggle('active', t===tab);
    document.querySelectorAll('.panel')[i].classList.toggle('active', t===tab);
  });
  if (tab==='flashcard') renderFlashcard();
  if (tab==='list')      renderList();
}

// ============================================================
//  EXCEL IMPORT
// ============================================================
function handleDragOver(e) { e.preventDefault(); document.getElementById('dropzone').classList.add('drag-over'); }
function handleDragLeave() { document.getElementById('dropzone').classList.remove('drag-over'); }
function handleDrop(e) {
  e.preventDefault(); handleDragLeave();
  const f = e.dataTransfer.files[0]; if(f) processExcelFile(f);
}
function handleFileSelect(e) {
  const f = e.target.files[0]; if(f) processExcelFile(f);
  e.target.value='';
}

function processExcelFile(file) {
  if (!file.name.match(/\.(xlsx|xls)$/i)) { showToast('error','‚úï Ch·ªâ h·ªó tr·ª£ .xlsx ho·∫∑c .xls'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
      if (!rows || rows.length===0) { showToast('error','‚úï File tr·ªëng ho·∫∑c kh√¥ng ƒë·ªçc ƒë∆∞·ª£c.'); return; }

      // Column aliases (lowercase)
      const COL = {
        word:        ['word'],
        meaning:     ['nghƒ©a ti·∫øng vi·ªát','meaning','nghia tieng viet','nghƒ©a','ngha tieng vit'],
        phonetics:   ['phonetics','phonetic','phi√™n √¢m','phien am'],
        description: ['description','descrition','m√¥ t·∫£','mo ta','desc'],
        example:     ['example','v√≠ d·ª•','vi du'],
        type:        ['type','lo·∫°i t·ª´','loai tu'],
        level:       ['level','c·∫•p ƒë·ªô','cap do'],
      };

      function getCol(row, aliases) {
        const keys = Object.keys(row).map(k => k.toLowerCase().trim());
        for (const a of aliases) {
          const i = keys.indexOf(a);
          if (i >= 0) return String(Object.values(row)[i]).trim();
        }
        return '';
      }

      const parsed = [];
      rows.forEach(row => {
        const word    = getCol(row, COL.word);
        const meaning = getCol(row, COL.meaning);
        if (!word || !meaning) return;
        parsed.push({
          word, meaning,
          phonetics:   getCol(row, COL.phonetics),
          description: getCol(row, COL.description),
          example:     getCol(row, COL.example),
          type:        getCol(row, COL.type),
          level:       getCol(row, COL.level),
          mastered:    false,
        });
      });

      if (!parsed.length) { showToast('error','‚úï Kh√¥ng t√¨m th·∫•y c·ªôt "Word" v√† "Nghƒ©a ti·∫øng Vi·ªát".'); return; }

      pendingImport = parsed.filter(p => !words.find(w => w.word.toLowerCase()===p.word.toLowerCase()));
      showImportModal(parsed.length, pendingImport.length);
    } catch(err) { showToast('error','‚úï L·ªói ƒë·ªçc file: '+err.message); }
  };
  reader.readAsArrayBuffer(file);
}

function showImportModal(total, newCount) {
  document.getElementById('modalSub').innerHTML =
    `üìä T·ªïng: <strong style="color:#fff">${total}</strong> t·ª´ &nbsp;¬∑&nbsp; `+
    `‚ú® M·ªõi: <strong style="color:var(--neon-green)">${newCount}</strong> &nbsp;¬∑&nbsp; `+
    `‚äò Tr√πng: <strong style="color:rgba(255,255,255,0.4)">${total-newCount}</strong>`;

  const list = document.getElementById('modalList');
  list.innerHTML = pendingImport.length ? pendingImport.map(w=>`
    <div class="modal-row">
      <div class="mw">${h(w.word)}</div>
      <div class="mm">${h(w.meaning)}${w.phonetics?` <span style="color:var(--neon-cyan);font-size:0.7rem">/${h(w.phonetics)}/</span>`:''}${w.type?` <span style="color:rgba(255,255,255,0.3);font-size:0.7rem">${h(w.type)}</span>`:''}</div>
      ${w.level?`<div class="mn">${h(w.level)}</div>`:''}
    </div>`).join('') :
    `<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.3);font-size:0.82rem">Kh√¥ng c√≥ t·ª´ m·ªõi n√†o.</div>`;

  document.getElementById('importModal').classList.add('show');
}

function confirmImport() {
  const n = pendingImport.length;
  words.push(...pendingImport);
  pendingImport = [];
  closeModal();
  saveData();
  buildQueue();
  showToast('success', `‚úì ƒê√£ th√™m ${n} t·ª´! D·ªØ li·ªáu ƒë√£ l∆∞u v√†o tr√¨nh duy·ªát.`);
}

function closeModal() { document.getElementById('importModal').classList.remove('show'); pendingImport=[]; }

// ============================================================
//  TEXT IMPORT
// ============================================================
function importText() {
  const raw = document.getElementById('wordInput').value.trim();
  if (!raw) { showToast('error','‚úï √î nh·∫≠p ƒëang tr·ªëng.'); return; }
  const added = [];
  raw.split('\n').filter(l=>l.trim()).forEach(line=>{
    const p = line.split('-').map(s=>s.trim());
    if (p.length<2||!p[0]||!p[1]) return;
    if (words.find(w=>w.word.toLowerCase()===p[0].toLowerCase())) return;
    added.push({word:p[0],meaning:p[1],phonetics:'',description:'',example:p[3]||'',type:p[2]||'',level:'',mastered:false});
  });
  if (!added.length) { showToast('error','‚úï Kh√¥ng c√≥ t·ª´ m·ªõi (ƒë√£ t·ªìn t·∫°i ho·∫∑c sai ƒë·ªãnh d·∫°ng).'); return; }
  words.push(...added);
  document.getElementById('wordInput').value='';
  saveData(); buildQueue();
  showToast('success',`‚úì ƒê√£ th√™m ${added.length} t·ª´. D·ªØ li·ªáu ƒë√£ l∆∞u.`);
}

function showToast(type, msg) {
  const t = document.getElementById('importToast');
  t.className = 'import-toast '+type;
  t.textContent = msg;
  clearTimeout(t._t);
  t._t = setTimeout(()=>{ t.className='import-toast'; }, 4200);
}

function clearAllData() {
  if (!confirm('X√≥a to√†n b·ªô t·ª´ v·ª±ng?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
  words=[]; saveData(); buildQueue();
  showToast('success','‚úì ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu.');
}

let autoPlay = true;   // auto-speak when flashcard loads

// ============================================================
//  TEXT-TO-SPEECH ENGINE
//
//  Ngu·ªìn √¢m thanh theo th·ª© t·ª± ∆∞u ti√™n:
//  1. Google Translate TTS  ‚Äî chu·∫©n, t·ª± nhi√™n, mi·ªÖn ph√≠
//  2. Dictionary.com audio  ‚Äî fallback th·ª© 2
//  3. Web Speech API        ‚Äî fallback cu·ªëi (offline)
// ============================================================
let ttsAudio = null;

function initTTS() {
  // pre-create audio element
  ttsAudio = new Audio();
  ttsAudio.crossOrigin = 'anonymous';
}

// T·∫°o URL Google Translate TTS
function googleTTSUrl(word, lang) {
  // D√πng proxy translate.googleapis.com ‚Äî kh√¥ng c·∫ßn key, ho·∫°t ƒë·ªông tr·ª±c ti·∫øp
  const tl = lang === 'en-GB' ? 'en-gb' : 'en';
  return `https://translate.googleapis.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(word)}&tl=${tl}&total=1&idx=0&textlen=${word.length}&client=gtx&prev=input&ttsspeed=1`;
}

function speakWord(word, accent, btnId) {
  if (!word) return;

  // D·ª´ng √¢m ƒëang ph√°t
  if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ''; }
  document.querySelectorAll('.fc-speak-btn,.speak-btn').forEach(b => b.classList.remove('playing'));

  const setPlaying = (on) => {
    if (!btnId) return;
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.toggle('playing', on);
  };

  // ‚îÄ‚îÄ Th·ª≠ Google Translate TTS ‚îÄ‚îÄ
  const url = googleTTSUrl(word, accent);
  const audio = ttsAudio;
  audio.src = url;

  setPlaying(true);

  audio.onended = audio.onerror = (e) => {
    setPlaying(false);
    // N·∫øu Google TTS l·ªói ‚Üí fallback Web Speech API
    if (e.type === 'error') speakFallback(word, accent, btnId);
  };

  audio.play().catch(() => {
    setPlaying(false);
    speakFallback(word, accent, btnId);
  });
}

// Fallback: Web Speech API (offline, gi·ªçng h·ªá th·ªëng)
function speakFallback(word, accent, btnId) {
  if (!('speechSynthesis' in window)) return;
  const utt = new SpeechSynthesisUtterance(word);
  utt.lang  = accent === 'en-GB' ? 'en-GB' : 'en-US';
  utt.rate  = 0.88;

  const setPlaying = (on) => {
    if (!btnId) return;
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.toggle('playing', on);
  };

  setPlaying(true);
  utt.onend = utt.onerror = () => setPlaying(false);
  speechSynthesis.cancel();
  speechSynthesis.speak(utt);
}

function autoSpeakCurrent() {
  if (!autoPlay) return;
  const c = studyQueue[currentIndex];
  if (c) setTimeout(() => speakWord(c.word, 'en-US', 'btnUS'), 500);
}

// ============================================================
//  QUEUE
// ============================================================
function buildQueue() {
  studyQueue = words.filter(w=>!w.mastered).map(w=>({...w}));
  for (let i=studyQueue.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [studyQueue[i],studyQueue[j]]=[studyQueue[j],studyQueue[i]]; }
  currentIndex=0; isFlipped=false; correctStreak=0;
}

// ============================================================
//  FLASHCARD
// ============================================================
function renderFlashcard() {
  const el = document.getElementById('fc-content');
  if (!words.length) { el.innerHTML='<div class="warn-box">‚ö† Ch∆∞a c√≥ t·ª´ v·ª±ng. V√†o tab "Nh·∫≠p T·ª´" ƒë·ªÉ th√™m!</div>'; return; }
  const rem = words.filter(w=>!w.mastered);
  if (!rem.length) {
    el.innerHTML=`<div class="card celebration"><span class="celebration-icon">üéâ</span><h2>Xu·∫•t S·∫Øc!</h2><p>B·∫°n ƒë√£ thu·ªôc h·∫øt <strong style="color:var(--neon-green)">${words.length}</strong> t·ª´ v·ª±ng!</p><button class="btn-restart" onclick="resetMastered()">‚Ü∫ H·ªçc L·∫°i</button></div>`;
    return;
  }
  if (!studyQueue.length||currentIndex>=studyQueue.length) buildQueue();
  const c = studyQueue[currentIndex];
  const m = words.filter(w=>w.mastered).length;
  const prog = Math.round((m/words.length)*100);

  el.innerHTML = `
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value">${rem.length}</div><div class="stat-label">C√≤n l·∫°i</div></div>
      <div class="stat-card"><div class="stat-value">${m}</div><div class="stat-label">ƒê√£ thu·ªôc</div></div>
      <div class="stat-card"><div class="stat-value">${correctStreak}</div><div class="stat-label">Streak üî•</div></div>
    </div>
    <div class="fc-controls">
      <div class="prog-info"><strong>${currentIndex+1}</strong> / ${studyQueue.length}</div>
      <div class="prog-wrap"><div class="prog-bar" style="width:${prog}%"></div></div>
      <div class="autoplay-toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="autoPlayToggle" ${autoPlay?'checked':''} onchange="autoPlay=this.checked">
          <span class="toggle-track"></span>
        </label>
        <span class="toggle-label">T·ª± ƒë·ªçc</span>
      </div>
      <div class="shuffle-badge">‚áÜ Ng·∫´u nhi√™n</div>
    </div>
    <div class="fc-scene">
      <div class="flashcard" id="theCard" onclick="flipCard()">
        <div class="fc-face fc-front">
          <div class="fc-hint">Nh·∫•p ƒë·ªÉ xem nghƒ©a ‚Üï</div>
          <div class="fc-word">${h(c.word)}</div>
          ${c.phonetics?`<div class="fc-phonetic">/${h(c.phonetics)}/</div>`:''}
          ${c.type?`<div class="fc-type">${h(c.type)}</div>`:''}
          ${c.level?`<div class="fc-level">${h(c.level)}</div>`:''}
          <div class="fc-speak-row" onclick="event.stopPropagation()">
            <button class="fc-speak-btn fc-speak-us" id="btnUS" onclick="speakWord('${c.word.replace(/'/g,"\\'")}','en-US','btnUS')">
              üîä US
            </button>
            <button class="fc-speak-btn fc-speak-uk" id="btnUK" onclick="speakWord('${c.word.replace(/'/g,"\\'")}','en-GB','btnUK')">
              üîä UK
            </button>
            <a class="fc-cambridge-link" href="https://dictionary.cambridge.org/dictionary/english/${encodeURIComponent(c.word)}" target="_blank" onclick="event.stopPropagation()">
              üìñ Cambridge
            </a>
          </div>
          ${c.example?`<div class="fc-example" style="margin-top:6px">üó£ ${h(c.example)}</div>`:''}
        </div>
        <div class="fc-face fc-back">
          <div class="fc-hint">Nghƒ©a ti·∫øng Vi·ªát</div>
          <div class="fc-word">${h(c.meaning)}</div>
          ${c.description?`<div class="fc-desc">${h(c.description)}</div>`:''}
          <div style="margin-top:8px;font-size:0.8rem;color:rgba(255,255,255,0.38)">${h(c.word)}${c.phonetics?` &nbsp;<span style="color:var(--neon-cyan)">/${h(c.phonetics)}/</span>`:''}</div>
          <div class="fc-speak-row" onclick="event.stopPropagation()">
            <button class="fc-speak-btn fc-speak-us" id="btnUS2" onclick="speakWord('${c.word.replace(/'/g,"\\'")}','en-US','btnUS2')">üîä US</button>
            <button class="fc-speak-btn fc-speak-uk" id="btnUK2" onclick="speakWord('${c.word.replace(/'/g,"\\'")}','en-GB','btnUK2')">üîä UK</button>
          </div>
          ${c.example?`<div class="fc-example" style="margin-top:6px">üó£ ${h(c.example)}</div>`:''}
        </div>
      </div>
    </div>
    <div class="action-row">
      <button class="btn btn-flip"     onclick="flipCard()">‚Üª L·∫≠t Th·∫ª</button>
      <button class="btn btn-skip"     onclick="skipWord()">‚Üí B·ªè Qua</button>
      <button class="btn btn-mastered" onclick="markMastered()">‚úì ƒê√£ Thu·ªôc!</button>
    </div>
    <div class="arrow-nav">
      <button class="btn-arrow" onclick="prevCard()" ${currentIndex===0?'disabled':''} title="Quay l·∫°i (‚Üê)">‚Üê</button>
      <span class="arrow-nav-hint">Ph√≠m ‚Üê ‚Üí ƒë·ªÉ ƒëi·ªÅu h∆∞·ªõng &nbsp;¬∑&nbsp; Space ƒë·ªÉ l·∫≠t</span>
      <button class="btn-arrow" onclick="skipWord()" title="Ti·∫øp theo (‚Üí)">‚Üí</button>
    </div>

  `;

  isFlipped=false;
  autoSpeakCurrent();
}

function flipCard() { const c=document.getElementById('theCard'); if(!c)return; isFlipped=!isFlipped; c.classList.toggle('flipped',isFlipped); }





// Global arrow key support (when typing input is not focused)
document.addEventListener('keydown', function(e) {
  const activeEl = document.activeElement;
  const isTyping = activeEl && (activeEl.tagName==='INPUT'||activeEl.tagName==='TEXTAREA');
  const isFlashcardPanel = document.getElementById('panel-flashcard')?.classList.contains('active');
  if (!isFlashcardPanel) return;
  if(e.key==='ArrowRight'){ e.preventDefault(); skipWord(); }
  if(e.key==='ArrowLeft'){  e.preventDefault(); prevCard(); }
  if(e.key===' '||e.key==='ArrowUp'||e.key==='ArrowDown'){ e.preventDefault(); flipCard(); }
});

function skipWord()    { correctStreak=0; nextCard(); }
function nextCard()    { currentIndex++; if(currentIndex>=studyQueue.length) buildQueue(); isFlipped=false; renderFlashcard(); }
function prevCard()    { if(currentIndex>0){ currentIndex--; isFlipped=false; renderFlashcard(); } }

function markMastered() {
  if(!studyQueue[currentIndex])return;
  const w=studyQueue[currentIndex].word;
  const i=words.findIndex(x=>x.word===w);
  if(i>=0){words[i].mastered=true; saveData();}
  studyQueue.splice(currentIndex,1);
  if(currentIndex>=studyQueue.length) currentIndex=0;
  if(!studyQueue.length) buildQueue();
  isFlipped=false; renderFlashcard(); updateStudyBadge();
}

function resetMastered() { words.forEach(w=>w.mastered=false); saveData(); buildQueue(); renderFlashcard(); }

// ============================================================
//  LIST
// ============================================================
function setFilter(f,btn) {
  listFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderList();
}

function renderList() {
  const tbody=document.getElementById('wordTableBody');
  const emptyEl=document.getElementById('listEmpty');
  if(!tbody)return;
  document.getElementById('totalCount').textContent=words.length;
  document.getElementById('masteredCount').textContent=words.filter(w=>w.mastered).length;
  let filtered=words;
  if(listFilter==='mastered') filtered=words.filter(w=>w.mastered);
  if(listFilter==='learning') filtered=words.filter(w=>!w.mastered);
  if(!filtered.length){tbody.innerHTML='';emptyEl.style.display='block';return;}
  emptyEl.style.display='none';
  tbody.innerHTML=filtered.map(w=>{
    const ri=words.indexOf(w);
    const lv=(w.level||'').trim().toLowerCase().replace(/\s/g,'');
    return `<tr class="${w.mastered?'mastered-row':''}">
      <td style="color:rgba(255,255,255,0.2);font-size:0.7rem">${ri+1}</td>
      <td>
        <div style="display:flex;align-items:center;gap:7px">
          <div><div class="td-word">${h(w.word)}</div>${w.phonetics?`<div class="td-phonetic">/${h(w.phonetics)}/</div>`:''}</div>
          <button class="speak-btn" onclick="speakWord('${w.word.replace(/'/g,"\\'")}','en-US',null)" title="Ph√°t √¢m US">üîä</button>
        </div>
      </td>
      <td class="td-meaning">${h(w.meaning)}${w.type?` <span style="color:rgba(255,255,255,0.3);font-size:0.7rem">${h(w.type)}</span>`:''}</td>
      <td style="text-align:center">${lv?`<span class="lv lv-${lv}">${h(w.level)}</span>`:''}</td>
      <td style="text-align:center">${w.mastered?'<span style="color:var(--neon-green)">‚úì</span>':'<span style="color:rgba(255,255,255,0.15)">¬∑</span>'}</td>
      <td><button class="chip-remove" onclick="removeWord(${ri})">‚úï</button></td>
    </tr>`;
  }).join('');
}

function removeWord(idx) {
  const word=words[idx]?.word; if(!word)return;
  if(!confirm(`X√≥a t·ª´ "${word}"?`))return;
  words.splice(idx,1); saveData(); buildQueue(); renderList(); updateStudyBadge();
}

// ============================================================
//  UTIL
// ============================================================
function h(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
//  INIT
// ============================================================
function renderAuthBar(user) {
  const bar = document.getElementById('authBar');
  if (user) {
    bar.innerHTML = `
      <div class="auth-user">
        <img class="auth-avatar" src="${user.photoURL}" alt="">
        <span class="auth-name">${user.displayName}</span>
      </div>
      <button class="btn-signout" onclick="window._signOut()">ƒêƒÉng xu·∫•t</button>
    `;
  } else {
    bar.innerHTML = '';
  }
}

function showOverlay()  { document.getElementById('loginOverlay').classList.remove('hidden'); }
function hideOverlay()  { document.getElementById('loginOverlay').classList.add('hidden'); }

// L·∫Øng nghe auth-changed ‚Äî ƒë√¢y l√† ƒëi·ªÉm kh·ªüi ƒë·ªông DUY NH·∫§T
window.addEventListener('auth-changed', async (e) => {
  const user = e.detail;
  renderAuthBar(user);
  if (user) {
    hideOverlay();
    initTTS();
    await showPacksScreen();
  } else {
    showOverlay();
  }
});
</script>
</body>
</html>
